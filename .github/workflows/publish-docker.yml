name: Publish Docker image

on:
  push:
    # Pattern matched against refs/tags
    tags:
      - 'v*.*.*'        # All versions
      - '!v*.*.*-test*' # Exclude test tags
  # Allow manual workflow dispatch for testing
  workflow_dispatch:
    inputs:
      push_images:
        description: 'Push images to Docker Hub'
        required: false
        default: true
        type: boolean

env:
  # Docker image name - can be overridden in repository variables
  # Format: dockerhub-username/image-name
  # Default: leventehunyadi/md2conf
  DOCKER_IMAGE_NAME: ${{ vars.DOCKER_IMAGE_NAME || 'leventehunyadi/md2conf' }}

jobs:
  publish_docker:
    runs-on: ubuntu-latest
    # Skip if tag ends with -test (fallback if negative pattern doesn't work)
    if: ${{ !contains(github.ref_name, '-test') || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Validate release branch (production tags only on master)
        if: ${{ startsWith(github.ref, 'refs/tags/') }}
        run: |
          # Get branches containing this commit
          BRANCHES=$(git branch -r --contains ${{ github.sha }} | grep -E 'origin/(master|main)' || echo "")

          if [[ -z "$BRANCHES" ]]; then
            echo "ERROR: Production version tags (v*.*.*) must be created on master/main branch"
            echo "This commit is not reachable from master/main."
            echo ""
            echo "For testing on feature branches, use:"
            echo "  - Test tags: v*.*.*-test (won't trigger)"
            echo "  - Manual dispatch: gh workflow run publish-docker.yml --ref <branch> -f push_images=false"
            exit 1
          fi

          echo "âœ“ Validated: Tag is on master/main branch"

      - name: Detect release type
        id: release_type
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "is_stable=false" >> $GITHUB_OUTPUT
            echo "is_test=true" >> $GITHUB_OUTPUT
            echo "Release type: Manual dispatch (test build)"
          elif [[ "${{ github.ref_name }}" =~ (a|b|rc) ]]; then
            echo "is_stable=false" >> $GITHUB_OUTPUT
            echo "is_test=false" >> $GITHUB_OUTPUT
            echo "Release type: Pre-release (${{ github.ref_name }})"
          else
            echo "is_stable=true" >> $GITHUB_OUTPUT
            echo "is_test=false" >> $GITHUB_OUTPUT
            echo "Release type: Stable release (${{ github.ref_name }})"
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE_NAME }}
          tags: |
            # For stable releases: create versioned tags + latest
            type=semver,pattern={{version}},enable=${{ steps.release_type.outputs.is_stable == 'true' }}
            type=semver,pattern={{major}},enable=${{ steps.release_type.outputs.is_stable == 'true' }}
            type=raw,value=latest,enable=${{ steps.release_type.outputs.is_stable == 'true' }}
            # For pre-releases: create versioned tags only (no latest)
            type=semver,pattern={{version}},enable=${{ steps.release_type.outputs.is_stable == 'false' && steps.release_type.outputs.is_test == 'false' }}
            # For manual dispatch: create SHA tag
            type=sha,prefix=,enable=${{ github.event_name == 'workflow_dispatch' }}

      - name: Build and push Docker images
        uses: docker/bake-action@v6
        with:
          files: |
            ./docker-bake.hcl
          targets: default
          source: .
          # Push logic:
          # - Stable/pre-release tags: always push (already validated branch)
          # - workflow_dispatch: respect push_images input
          push: ${{ (startsWith(github.ref, 'refs/tags/') && !contains(github.ref_name, '-test')) || (github.event_name == 'workflow_dispatch' && inputs.push_images) }}
          set: |
            *.cache-from=type=gha,scope=md2conf-docker
            *.cache-to=type=gha,mode=max,scope=md2conf-docker
            base.tags=${{ join(fromJSON(steps.meta.outputs.json).tags, '-minimal,') }}-minimal
            mermaid.tags=${{ join(fromJSON(steps.meta.outputs.json).tags, '-mermaid,') }}-mermaid
            plantuml.tags=${{ join(fromJSON(steps.meta.outputs.json).tags, '-plantuml,') }}-plantuml
            all.tags=${{ steps.meta.outputs.tags }}
